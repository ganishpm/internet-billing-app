<%- include('../partials/header') %>

<div class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-800">Monitoring PPPoE</h2>
        <p class="text-gray-600 mt-1">Pantau status koneksi pelanggan PPPoE secara real-time</p>
    </div>
    <button onclick="fetchPPPoEData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition">
        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
    </button>
</div>

<!-- Status Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Total Pelanggan</p>
                <p class="text-3xl font-bold text-gray-800 mt-2" id="totalUsers">-</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-users text-blue-600"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Aktif</p>
                <p class="text-3xl font-bold text-green-600 mt-2" id="activeUsers">-</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-wifi text-green-600"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Offline / Disabled</p>
                <p class="text-3xl font-bold text-red-600 mt-2" id="offlineUsers">-</p>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-wifi-slash text-red-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="bg-white rounded-xl shadow-md overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800">Daftar Pelanggan</h3>
        <div id="loadingIndicator" class="hidden text-sm text-blue-600">
            <i class="fas fa-spinner fa-spin mr-2"></i>Mengambil data...
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50 border-b">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profile</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Caller-ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uptime</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                </tr>
            </thead>
            <tbody id="pppoeTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Data akan diisi oleh JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<script>
let pppoeData = [];

// Fungsi untuk menampilkan notifikasi
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 slide-in ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.innerHTML = `<div class="flex items-center"><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${message}</div>`;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

// Fungsi untuk memformat uptime
function formatUptime(uptimeStr) {
    if (!uptimeStr || uptimeStr === '0s') return '-';
    const parts = uptimeStr.match(/(\d+d)?\s*(\d+h)?\s*(\d+m)?\s*(\d+s)?/);
    if (!parts) return uptimeStr;
    let formatted = [];
    if (parts[1]) formatted.push(parts[1]);
    if (parts[2]) formatted.push(parts[2]);
    if (parts[3]) formatted.push(parts[3]);
    return formatted.join(' ') || uptimeStr;
}

// Fungsi untuk merender tabel
function renderTable(data) {
    const tableBody = document.getElementById('pppoeTableBody');
    tableBody.innerHTML = '';

    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Tidak ada data pelanggan.</td></tr>';
        return;
    }

    data.forEach(user => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        const statusBadge = user.active 
            ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Aktif</span>'
            : user.disabled 
                ? '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Disabled</span>'
                : '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Offline</span>';

        const actionButtons = user.disabled
            ? `<button onclick="enableUser('${user.name}')" class="text-green-600 hover:text-green-900 mr-3" title="Enable"><i class="fas fa-check-circle"></i></button>`
            : `<button onclick="disableUser('${user.name}')" class="text-red-600 hover:text-red-900 mr-3" title="Disable"><i class="fas fa-ban"></i></button>`;

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.profile}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.callerId}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.address}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatUptime(user.uptime)}</td>
            <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actionButtons}</td>
        `;
        tableBody.appendChild(row);
    });
}

// Fungsi untuk memperbarui statistik
function updateStats(data) {
    const total = data.length;
    const active = data.filter(u => u.active).length;
    const offline = total - active;

    document.getElementById('totalUsers').textContent = total;
    document.getElementById('activeUsers').textContent = active;
    document.getElementById('offlineUsers').textContent = offline;
}

// Fungsi untuk mengambil data dari server
async function fetchPPPoEData() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    loadingIndicator.classList.remove('hidden');

    try {
        const response = await fetch('/pppoe/data');
        const result = await response.json();
        
        if (result.success) {
            pppoeData = result.data;
            renderTable(pppoeData);
            updateStats(pppoeData);
        } else {
            showToast(result.message || 'Gagal mengambil data', 'error');
        }
    } catch (error) {
        console.error('Error fetching PPPoE data:', error);
        showToast('Terjadi kesalahan pada koneksi', 'error');
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}

// Fungsi untuk enable user
async function enableUser(name) {
    try {
        const response = await fetch(`/pppoe/enable/${name}`, { method: 'POST' });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'error');
        if (result.success) fetchPPPoEData();
    } catch (error) {
        showToast('Gagal meng-enable user', 'error');
    }
}

// Fungsi untuk disable user
async function disableUser(name) {
    if (!confirm(`Apakah Anda yakin ingin men-disable user ${name}?`)) return;
    
    try {
        const response = await fetch(`/pppoe/disable/${name}`, { method: 'POST' });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'error');
        if (result.success) fetchPPPoEData();
    } catch (error) {
        showToast('Gagal meng-disable user', 'error');
    }
}

// Ambil data saat halaman dimuat
document.addEventListener('DOMContentLoaded', fetchPPPoEData);

// Auto-refresh setiap 30 detik
setInterval(fetchPPPoEData, 30000);
</script>

<%- include('../partials/footer') %>
