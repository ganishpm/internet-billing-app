<%- include('../partials/header') %>

<style>
    /* CSS untuk sorting tetap sama, tidak perlu diubah */
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
    }
    .sortable:hover {
        background-color: #f3f4f6;
    }
    .sort-icon {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.7em;
        color: #9ca3af;
    }
    .sort-icon.active {
        color: #3b82f6;
    }
</style>

<div class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-800">Monitoring PPPoE</h2>
        <p class="text-gray-600 mt-1">Pantau status koneksi pelanggan PPPoE secara real-time</p>
    </div>
    <button onclick="fetchPPPoEData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition">
        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
    </button>
</div>

<!-- Status Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Total Pelanggan</p>
                <p class="text-3xl font-bold text-gray-800 mt-2" id="totalUsers">-</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-users text-blue-600"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Aktif</p>
                <p class="text-3xl font-bold text-green-600 mt-2" id="activeUsers">-</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-wifi text-green-600"></i>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm">Offline / Disabled</p>
                <p class="text-3xl font-bold text-red-600 mt-2" id="offlineUsers">-</p>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-wifi-slash text-red-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="bg-white rounded-xl shadow-md overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800">Daftar Pelanggan</h3>
        <div id="loadingIndicator" class="hidden text-sm text-blue-600">
            <i class="fas fa-spinner fa-spin mr-2"></i>Mengambil data...
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead id="pppoeTableHead" class="bg-gray-50 border-b">
                <tr>
                    <!-- PERBAIKAN 1: Ubah <span> menjadi <i> dan tambahkan kelas dasar 'fas fa-sort' -->
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="name">
                        Nama
                        <i class="sort-icon fas fa-sort"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="profile">
                        Profile
                        <i class="sort-icon fas fa-sort"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="callerId">
                        Caller-ID
                        <i class="sort-icon fas fa-sort"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="address">
                        Address
                        <i class="sort-icon fas fa-sort"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="uptime">
                        Uptime
                        <i class="sort-icon fas fa-sort"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="status">
                        Status
                        <i class="sort-icon fas fa-sort"></i>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                </tr>
            </thead>
            <tbody id="pppoeTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Data akan diisi oleh JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<script>
let pppoeData = [];
let currentSortColumn = 'name';
let currentSortOrder = 'asc';

// Fungsi untuk menampilkan notifikasi
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 slide-in ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.innerHTML = `<div class="flex items-center"><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${message}</div>`;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

// Fungsi untuk memformat uptime
function formatUptime(uptimeStr) {
    if (!uptimeStr || uptimeStr === '0s') return '-';
    const parts = uptimeStr.match(/(\d+d)?\s*(\d+h)?\s*(\d+m)?\s*(\d+s)?/);
    if (!parts) return uptimeStr;
    let formatted = [];
    if (parts[1]) formatted.push(parts[1]);
    if (parts[2]) formatted.push(parts[2]);
    if (parts[3]) formatted.push(parts[3]);
    return formatted.join(' ') || uptimeStr;
}

// Fungsi untuk merender tabel
function renderTable(data) {
    const tableBody = document.getElementById('pppoeTableBody');
    tableBody.innerHTML = '';

    if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Tidak ada data pelanggan.</td></tr>';
        return;
    }

    data.forEach(user => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        const statusBadge = user.active
            ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Aktif</span>'
            : user.disabled
                ? '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Disabled</span>'
                : '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Offline</span>';

        const actionButtons = user.disabled
            ? `<button onclick="enableUser('${user.name}')" class="text-green-600 hover:text-green-900 mr-3" title="Enable"><i class="fas fa-check-circle"></i></button>`
            : `<button onclick="disableUser('${user.name}')" class="text-red-600 hover:text-red-900 mr-3" title="Disable"><i class="fas fa-ban"></i></button>`;

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.profile}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.callerId}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.address}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatUptime(user.uptime)}</td>
            <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actionButtons}</td>
        `;
        tableBody.appendChild(row);
    });
}

// Fungsi untuk memperbarui statistik
function updateStats(data) {
    const total = data.length;
    const active = data.filter(u => u.active).length;
    const offline = total - active;

    document.getElementById('totalUsers').textContent = total;
    document.getElementById('activeUsers').textContent = active;
    document.getElementById('offlineUsers').textContent = offline;
}

// Fungsi utama untuk mengurutkan data
function sortData(column) {
    if (currentSortColumn === column) {
        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortOrder = 'asc';
    }

    let sortedData = [...pppoeData];

    sortedData.sort((a, b) => {
        let valueA, valueB;

        if (column === 'status') {
            const statusOrder = { 'Aktif': 1, 'Offline': 2, 'Disabled': 3 };
            const statusA = a.active ? 'Aktif' : (a.disabled ? 'Disabled' : 'Offline');
            const statusB = b.active ? 'Aktif' : (b.disabled ? 'Disabled' : 'Offline');
            valueA = statusOrder[statusA];
            valueB = statusOrder[statusB];
        } else if (column === 'uptime') {
            valueA = parseUptimeToSeconds(a.uptime);
            valueB = parseUptimeToSeconds(b.uptime);
        } else {
            valueA = a[column] || '';
            valueB = b[column] || '';
            if (typeof valueA === 'string') {
                return currentSortOrder === 'asc' 
                    ? valueA.localeCompare(valueB) 
                    : valueB.localeCompare(valueA);
            }
        }
        
        if (valueA < valueB) {
            return currentSortOrder === 'asc' ? -1 : 1;
        }
        if (valueA > valueB) {
            return currentSortOrder === 'asc' ? 1 : -1;
        }
        return 0;
    });

    updateSortIcons();
    renderTable(sortedData);
}

// PERBAIKAN 2: Sederhanakan fungsi updateSortIcons untuk menghindari konflik kelas
function updateSortIcons() {
    const headers = document.querySelectorAll('#pppoeTableHead th.sortable');
    headers.forEach(header => {
        const icon = header.querySelector('.sort-icon');
        // Reset semua ikon ke keadaan default
        icon.className = 'sort-icon fas fa-sort';

        if (header.dataset.column === currentSortColumn) {
            // Jika ini adalah kolom yang aktif, ganti kelasnya
            const newIconClass = currentSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
            icon.className = `sort-icon fas ${newIconClass} active`;
        }
    });
}

// Fungsi helper untuk mengonversi uptime string ke detik
function parseUptimeToSeconds(uptimeStr) {
    if (!uptimeStr || uptimeStr === '0s' || uptimeStr === '-') return 0;
    let totalSeconds = 0;
    const days = uptimeStr.match(/(\d+)d/);
    const hours = uptimeStr.match(/(\d+)h/);
    const minutes = uptimeStr.match(/(\d+)m/);
    const seconds = uptimeStr.match(/(\d+)s/);

    if (days) totalSeconds += parseInt(days[1]) * 86400;
    if (hours) totalSeconds += parseInt(hours[1]) * 3600;
    if (minutes) totalSeconds += parseInt(minutes[1]) * 60;
    if (seconds) totalSeconds += parseInt(seconds[1]);
    
    return totalSeconds;
}

// Fungsi untuk mengambil data dari server
async function fetchPPPoEData() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    loadingIndicator.classList.remove('hidden');

    try {
        const response = await fetch('/pppoe/data');
        const result = await response.json();

        if (result.success) {
            pppoeData = result.data;
            sortData(currentSortColumn);
            updateStats(pppoeData);
        } else {
            showToast(result.message || 'Gagal mengambil data', 'error');
        }
    } catch (error) {
        console.error('Error fetching PPPoE data:', error);
        showToast('Terjadi kesalahan pada koneksi', 'error');
    } finally {
        loadingIndicator.classList.add('hidden');
    }
}

// Fungsi untuk enable user
async function enableUser(name) {
    try {
        const response = await fetch(`/pppoe/enable/${name}`, { method: 'POST' });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'error');
        if (result.success) fetchPPPoEData();
    } catch (error) {
        showToast('Gagal meng-enable user', 'error');
    }
}

// Fungsi untuk disable user
async function disableUser(name) {
    if (!confirm(`Apakah Anda yakin ingin men-disable user ${name}?`)) return;

    try {
        const response = await fetch(`/pppoe/disable/${name}`, { method: 'POST' });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'error');
        if (result.success) fetchPPPoEData();
    } catch (error) {
        showToast('Gagal meng-disable user', 'error');
    }
}

// Event listener untuk klik pada header
document.getElementById('pppoeTableHead').addEventListener('click', (e) => {
    const sortableHeader = e.target.closest('.sortable');
    if (sortableHeader) {
        const column = sortableHeader.dataset.column;
        sortData(column);
    }
});

// Ambil data saat halaman dimuat
document.addEventListener('DOMContentLoaded', fetchPPPoEData);

// Auto-refresh setiap 30 detik
setInterval(fetchPPPoEData, 30000);
</script>

<%- include('../partials/footer') %>
